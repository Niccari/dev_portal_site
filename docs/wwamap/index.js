(()=>{"use strict";var e={312:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IMAGE_UNIT_WIDTH_PX=void 0,t.IMAGE_UNIT_WIDTH_PX=40},785:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sleepMs=void 0,t.sleepMs=async e=>await new Promise((t=>{setTimeout((()=>{t()}),e)}))},870:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),t.MapAttribute=void 0,(a=t.MapAttribute||(t.MapAttribute={}))[a.x=6]="x",a[a.y=7]="y"},74:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DataLoader=void 0,t.DataLoader=class{constructor(e){this.fileLoader=e}async loadAsync(e){const t=await this.fileLoader.loadAsync(e,"");return"string"==typeof t?this.parseDataAsync(t):Promise.reject("Unsupported return type")}decode(e){let t="",a=0;for(let r=0;r<e.length-3;r++)if(e.charCodeAt(a)==e.charCodeAt(a+1)){const r=e.charCodeAt(a+2)+1;for(let o=0;o<r;++o)t+=e[a];a+=3}else t+=e[a],a+=1;return t}loadWord(e){return t=>e.charCodeAt(t)+256*e.charCodeAt(t+1)}parseMapItem(e,t,a){const r=[];for(let o=0;o<t;o++){r[o]=[];for(let s=0;s<t;s++){const n=e+2*(s+o*t),i=n+t*t*2;r[o][s]={obj:a(i),bg:a(n)}}}return r}parseAttrs(e,t,a,r){const o=[];for(let s=0;s<a;s++){o[s]=[];for(let a=0;a<t;a++)o[s][a]=r(e+2*(a+s*t))}return o}validateSize(e,t,a){return e<=501||t<=200||a<=200}async parseDataAsync(e){const t=this.decode(e),a=this.loadWord(t),r=a(46),o=a(34),s=a(36);if(!this.validateSize(r,o,s))return Promise.reject("Invalid data size!");const n=90+r*r*4,i=n+60*o*2,d=this.parseMapItem(90,r,a),I=this.parseAttrs(n,60,o,a),_=this.parseAttrs(i,60,s,a),l=Array.from(Array(12).keys()).map((e=>a(20+e)%256));return{check:a(0),version:a(2),hpInit:a(10),strInit:a(12),defInit:a(14),goldInit:a(16),items:l,hpMap:a(32),numBg:o,numObj:s,xInit:a(38),yInit:a(40),xGameover:a(42),yGameover:a(44),sizeMap:r,numMessage:a(48),map:d,bgAttrs:I,objAttrs:_}}}},800:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FileLoader=void 0,t.FileLoader=class{loadAsync(e,t){return e.type!==t?Promise.reject("Invalid file type"):new Promise(((a,r)=>{const o=new FileReader;o.onload=e=>{var t;const o=null===(t=e.target)||void 0===t?void 0:t.result;o?a(o):r()},t.includes("image")?o.readAsDataURL(e):o.readAsBinaryString(e)}))}}},874:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ImageLoader=void 0,t.ImageLoader=class{constructor(e){this.fileLoader=e}async loadDataUrlAsync(e){const t=await this.fileLoader.loadAsync(e,"image/gif");return"string"==typeof t?t:Promise.reject("Unsupported return type")}}},459:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Presenter=void 0;const r=a(312),o=a(156);t.Presenter=class{showGifInfo(e){const{width:t,height:a}=e;return["横方向の画像数, 縦方向の画像数 = "+Math.floor(t/r.IMAGE_UNIT_WIDTH_PX)+", "+Math.floor(a/r.IMAGE_UNIT_WIDTH_PX)]}showMapInfo(e){return["マップバージョン:"+e.version/10,"HP:"+e.hpInit+"/"+e.hpMap,"攻撃力:"+e.strInit,"防御力:"+e.defInit,"所持金:"+e.goldInit,"所持アイテム番号:"+e.items.map((e=>e.toString())).join(","),"MAX HP:"+e.hpMap,"背景パーツ 最大数:"+e.numBg,"物体パーツ 最大数:"+e.numObj,"初期位置(x, y): ("+e.xInit+", "+e.yInit+")","ゲームオーバー位置(x, y): ("+e.xGameover+", "+e.yGameover+")","マップサイズ(w, h):"+e.sizeMap+"x"+e.sizeMap]}resolveErrorMessage(e){switch(e){case o.ErrorCode.DataLoadFailed:return"マップファイルを読み込めませんでした。WWAで使用しているマップファイルかご確認ください。";case o.ErrorCode.ImageLoadFailed:return"画像ファイルを読み込めませんでした。WWAで使用している画像ファイルかご確認ください。"}}}},156:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorCode=void 0,(a=t.ErrorCode||(t.ErrorCode={}))[a.DataLoadFailed=1]="DataLoadFailed",a[a.ImageLoadFailed=2]="ImageLoadFailed"},132:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const r=a(312),o=a(785),s=a(870),n=a(855);var i;!function(e){e.UPLOADED_ID_GIF="gif_uploaded",e.UPLOADED_ID_MAP="dat_uploaded",e.INPUT_ID_GIF="gif_file",e.INPUT_ID_MAP="dat_file",e.GIF_SRC_PREVIEW="gif_src_preview",e.IS_LOADING="is_loading",e.ERROR_MESSAGE="error_message",e.CANVAS_GIF_MAP_PREVIEW="gif_map_preview",e.GIF_MAP_DOWNLOAD="gif_map_download",e.GIF_MAP_DOWNLOAD_BUTTON="git_map_download_button"}(i||(i={})),t.View=class{constructor(e,t){this.addFileEvent(i.INPUT_ID_GIF,e),this.addFileEvent(i.INPUT_ID_MAP,t)}addFileEvent(e,t){const a=document.getElementById(e);if(!a)return;const r=e=>{var a;const r=null===(a=e.target)||void 0===a?void 0:a.files;r&&t(r[0])};a.addEventListener("change",r),a.addEventListener("dragstart",r)}fetchImageTag(){return document.getElementById(i.GIF_SRC_PREVIEW)}async showMap(e){const t=this.fetchImageTag(),a=this.getCanvasById(i.CANVAS_GIF_MAP_PREVIEW);if(!t||!a)return;const o=a.getContext("2d");if(!o)return;const n=e.sizeMap;a.width=n*r.IMAGE_UNIT_WIDTH_PX,a.height=n*r.IMAGE_UNIT_WIDTH_PX;const d=e.map;for(let a=0;a<n;a++)for(let i=0;i<n;i++){const n=d[a][i].bg,I=d[a][i].obj,_=e.bgAttrs[n],l=e.objAttrs[I];if(!_||!l)continue;const c=_[s.MapAttribute.x],A=_[s.MapAttribute.y],u=l[s.MapAttribute.x],g=l[s.MapAttribute.y];o.drawImage(t,c,A,r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX,i*r.IMAGE_UNIT_WIDTH_PX,a*r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX),0==u&&0==g||o.drawImage(t,u,g,r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX,i*r.IMAGE_UNIT_WIDTH_PX,a*r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX,r.IMAGE_UNIT_WIDTH_PX)}const I=document.getElementById(i.GIF_MAP_DOWNLOAD);I&&(I.href=a.toDataURL())}async showGif(e){return new Promise(((t,a)=>{const r=this.fetchImageTag();r?(r.onload=()=>{t({width:r.width,height:r.height,dataUrl:e})},r.src=e):a()}))}getCanvasById(e){return document.getElementById(e)||null}enableDownloadButton(e){const t=document.getElementById(i.GIF_MAP_DOWNLOAD_BUTTON);t&&(t.disabled=!e)}resolveTag(e){switch(e){case n.TagId.GIF_UPLOADED:return i.UPLOADED_ID_GIF;case n.TagId.MAP_UPLOADED:return i.UPLOADED_ID_MAP;case n.TagId.LOADING:return i.IS_LOADING}}showIfNeeded(e,t){const a=this.resolveTag(e),r=document.getElementById(a);if(!r)return;r.style.display=t?"inline-block":"none"}async showError(e){const t=document.getElementById(i.ERROR_MESSAGE);t&&(t.style.display="block",t.innerHTML=e,await(0,o.sleepMs)(3e3),t.style.display="none")}}},855:(e,t)=>{var a;Object.defineProperty(t,"__esModule",{value:!0}),t.TagId=void 0,(a=t.TagId||(t.TagId={}))[a.MAP_UPLOADED=1]="MAP_UPLOADED",a[a.GIF_UPLOADED=2]="GIF_UPLOADED",a[a.LOADING=3]="LOADING"}},t={};function a(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,a),s.exports}(()=>{const e=a(785),t=a(74),r=a(800),o=a(874),s=a(459),n=a(156),i=a(132),d=a(855),I=new r.FileLoader,_=new t.DataLoader(I),l=new o.ImageLoader(I),c=new s.Presenter,A={mapInfo:void 0,imageInfo:void 0},u=new i.View((async e=>{const t=await l.loadDataUrlAsync(e).catch((()=>{const e=c.resolveErrorMessage(n.ErrorCode.ImageLoadFailed);u.showError(e)}));t&&(u.showGif(t),g(Object.assign(Object.assign({},A),{imageInfo:await u.showGif(t)})))}),(async e=>{const t=await _.loadAsync(e).catch((()=>{const e=c.resolveErrorMessage(n.ErrorCode.DataLoadFailed);u.showError(e)}));t&&g(Object.assign(Object.assign({},A),{mapInfo:t}))})),g=e=>{A.imageInfo=e.imageInfo,A.mapInfo=e.mapInfo,D()},D=async()=>{const{imageInfo:t,mapInfo:a}=A,r=void 0!==a,o=void 0!==t,s=r&&o;u.showIfNeeded(d.TagId.LOADING,!0),u.showIfNeeded(d.TagId.MAP_UPLOADED,r),u.showIfNeeded(d.TagId.GIF_UPLOADED,o),s&&(await(0,e.sleepMs)(50),await u.showMap(a)),u.showIfNeeded(d.TagId.LOADING,!1),u.enableDownloadButton(s)}})()})();